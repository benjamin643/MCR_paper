
---
title: "B Cell (CD19+) and Macrophage (CD68+) Spatial Interaction in the Tumor Microenvironment Associated with Higher Survival Probability"
date: '`r format(Sys.time(), "%Y-%m-%d")`'
output:
  html_document
hitheme: tomorrow
highlighter: highlight.js
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "../results") })
---

```{r setup, message=FALSE, echo=TRUE, warning=FALSE}
library(tidyverse)
library(readxl)
library(janitor)
library(skimr)
library(phenoptr)
library(phenoptrReports)
library(rtree)
library(data.table)
library(pivottabler)
library(ggpubr)
library(zoo)
library(survival)
library(lubridate)
library(survminer)
library(reReg)
library(naniar)
library(kableExtra)

knitr::opts_chunk$set(echo = FALSE,
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6
)

suppressMessages(library(tidyverse))

theme_set(theme_bw() + theme(legend.position = "bottom"))
```

```{r}
load(here::here("data", "20210728_cox_data.Rdata"))
load(here::here("data", "20210728count_within_cd4_macro.Rdata"))
load(here::here("data", "20210728count_within_cd4_tcell.Rdata"))
load(here::here("data", "20210728count_within_tcell_macro.Rdata"))
load(here::here("data", "20210728count_within_macro_bcell.Rdata"))

```


# Research Question:

* Do B Cells (CD19+) and Macrophages (CD68+) interact with each other in a meaningful way that leads to increased overall survival? 


# Table1 of variables

```{r}
# can change eval to TRUE if output is html

cox_data$status = factor(cox_data$Death, levels=c(0,1), labels = c("Alive", "Death"))

cox_data$`B Cell Macrophage Interaction Variable` = cox_data$from_with_macro_bcell_standard

my_table = table1(~  `B Cell Macrophage Interaction Variable` +`CD19+ Percent` + `CD68+ Percent`+`CD3+ CD8+ Percent`+ `CD3+ CD8- Percent` + `CK+ Percent` + `Age at Diagnosis`+ Grade   + `Treatment Effect` + Debulking | status, data=cox_data %>% filter(Primary == "1"))

my_table 

# Note, do not have the survival time in here be cause the numbers may be misleading. Some of those (48) patients have censored data, which is taken into account in the cox and kaplan calculations but not in a simple summary.
```



# Cell Infiltrate - Kaplan Curves

* Note: at the 50th percentile, There were zero B cells interacting with either T Cells (CD3+ CD8+) or CD4 cells (CD3+ CD8-)



```{r}
## Survival curve for B Cell (CD19+) presence tumor region (count)


bcell_data = cox_data %>% filter(Primary == "1") %>% select(survival_time, `CD19+ Percent`, `Sample Name`, Death, time_to_event_binary) %>% unique()

bcell_data = bcell_data  %>% mutate(bcell_percent_binary = case_when(
  `CD19+ Percent` >= quantile(`CD19+ Percent`, .5) ~ 1,
  TRUE~ 0
)) 


sf_bcell = surv_fit(Surv(survival_time, Death) ~ bcell_percent_binary, conf.type = "log-log", data=bcell_data)


#Graph of Kaplan-Meier Curve

bcell_kaplan_primary  = ggsurvplot(sf_bcell, 
   legend.title = "Cell Presence (CD19+)", 
   legend.labs = c("Low", "High"),
   #legend = c(7000, 0.8),
   font.legend = c(11, "bold", "black"),
   title = "A", 
   #subtitle = "",
   xlab = "Time (days)",
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(12, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(3600, 0.6),
   conf.int = TRUE
   ) 

bcell_kaplan_primary$plot <- bcell_kaplan_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.5", size = 3)

# all tumors included
bcell_data = cox_data %>% select(survival_time, `CD19+ Percent`, `Sample Name`, Death, time_to_event_binary) %>% unique()

bcell_data = bcell_data  %>% mutate(bcell_percent_binary = case_when(
  `CD19+ Percent` >= quantile(`CD19+ Percent`, .5) ~ 1,
  TRUE~ 0
)) 


sf_bcell = surv_fit(Surv(survival_time, Death) ~ bcell_percent_binary, conf.type = "log-log", data=bcell_data)

# for hazard ratio
coxph(Surv(survival_time, Death) ~ bcell_percent_binary, data =bcell_data ) %>% 
gtsummary::tbl_regression(exp = TRUE) 

#Graph of Kaplan-Meier Curve

bcell_kaplan  = ggsurvplot(sf_bcell, 
   legend.title = "Cell Presence (CD19+)", 
   legend.labs = c("Low", "High"),
   #legend = c(7000, 0.8),
   font.legend = c(11, "bold", "black"),
   title = "B", 
   #subtitle = "",
   xlab = "Time (days)",
   ylab = NULL,
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(12, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(5400, 0.6),
   conf.int = TRUE
   ) 

bcell_kaplan$plot <- bcell_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.62", size = 3)


#coxph(Surv(survival_time, Death) ~ bcell_percent_binary, data =bcell_data ) %>% 
#gtsummary::tbl_regression(exp = TRUE) 

```


```{r}
## Survival curve Macrophage (CD68+) presence tumor region (count)

macro_data = cox_data %>% filter(Primary == "1") %>% select(survival_time, `CD68+ Percent`, `Sample Name`, Death) %>% unique()

macro_data = macro_data  %>% mutate(macro_percent_binary = case_when(
  `CD68+ Percent` >= quantile(`CD68+ Percent`, .5, na.rm=TRUE) ~ 1,
  TRUE~ 0
)) 


sf_macro = surv_fit(Surv(survival_time, Death) ~ macro_percent_binary,conf.type = "log-log", data=macro_data)

#Graph of Kaplan-Meier Curve

macrophage_kaplan_primary = ggsurvplot(sf_macro, 
   legend.title = "Cell Presence (CD68+)", 
   legend.labs = c("Low", "High"),
   #legend = c(.8, 0.8),
   font.legend = c(11, "bold", "black"),
   title = "E", 
   #subtitle = "",
   xlab = "Time (days)",
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(12, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(3600, 0.6),
   conf.int = TRUE
   ) 

macrophage_kaplan_primary$plot <- macrophage_kaplan_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.93 ", size = 3) 


# all tumors included 

macro_data = cox_data %>% select(survival_time, `CD68+ Percent`, `Sample Name`, Death) %>% unique()

macro_data = macro_data  %>% mutate(macro_percent_binary = case_when(
  `CD68+ Percent` >= quantile(`CD68+ Percent`, .5, na.rm=TRUE) ~ 1,
  TRUE~ 0
)) 


sf_macro = surv_fit(Surv(survival_time, Death) ~ macro_percent_binary,conf.type = "log-log", data=macro_data)

#Graph of Kaplan-Meier Curve

macrophage_kaplan = ggsurvplot(sf_macro, 
   legend.title = "Cell Presence (CD68+)", 
   legend.labs = c("Low", "High"),
   #legend = c(.8, 0.8),
   font.legend = c(11, "bold", "black"),
   title = "F", 
  #subtitle = "",
   xlab = "Time (days)",
   ylab = NULL,
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(12, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(5400, 0.6),
   conf.int = TRUE
   ) 

macrophage_kaplan$plot <- macrophage_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.99 ", size = 3) 

#coxph(Surv(survival_time, Death) ~ macro_percent_binary, data =macro_data ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 

```


```{r}
## Survival curve for T Cell (CD8+) presence tumor region (count)


tcell_data = cox_data %>% filter(Primary == "1") %>% select(survival_time, `CD3+ CD8+ Percent`, `Sample Name`, Death) %>% unique()

tcell_data = tcell_data  %>% mutate(tcell_count_binary = case_when(
  `CD3+ CD8+ Percent` >= quantile(`CD3+ CD8+ Percent`, .5, na.rm = TRUE) ~ 1,
  TRUE~ 0
)) 


sf_tcell = surv_fit(Surv(survival_time, Death) ~ tcell_count_binary,conf.type = "log-log", data=tcell_data)




#Graph of Kaplan-Meier Curve

tcell_kaplan_primary = ggsurvplot(sf_tcell, 
           legend.title = "Cell Presence (CD8+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "A", 
           #subtitle = "",
           xlab = "Time (days)",
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(12, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(3600, 0.6),
           conf.int = TRUE) 


tcell_kaplan_primary$plot <- tcell_kaplan_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio:  0.7", size = 3)



#coxph(Surv(survival_time, Death) ~ tcell_count_binary, data = tcell_data ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 

surv_diff <- survdiff(Surv(survival_time, Death) ~ tcell_count_binary, data = tcell_data)


# all tumors included 

tcell_data = cox_data  %>% select(survival_time, `CD3+ CD8+ Percent`, `Sample Name`, Death) %>% unique()

tcell_data = tcell_data  %>% mutate(tcell_count_binary = case_when(
  `CD3+ CD8+ Percent` >= quantile(`CD3+ CD8+ Percent`, .5, na.rm = TRUE) ~ 1,
  TRUE~ 0
)) 


sf_tcell = surv_fit(Surv(survival_time, Death) ~ tcell_count_binary,conf.type = "log-log", data=tcell_data)




#Graph of Kaplan-Meier Curve

tcell_kaplan = ggsurvplot(sf_tcell, 
           legend.title = "Cell Presence (CD8+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "B", 
           #subtitle = "",
           xlab = "Time (days)",
           ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(5400, 0.6),
           conf.int = TRUE) 


tcell_kaplan$plot <- tcell_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio:  0.78", size = 3)



#coxph(Surv(survival_time, Death) ~ tcell_count_binary, data = tcell_data ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 

surv_diff <- survdiff(Surv(survival_time, Death) ~ tcell_count_binary, data = tcell_data)
```



```{r}
## Survival curve for T Cell (CD4+) presence in whole sample (count)


cd4_data = cox_data %>% filter(Primary == "1") %>% select(survival_time, `CD3+ CD8- Percent`, `Sample Name`, Death) %>% unique()

cd4_data = cd4_data  %>% mutate(cd4_count_binary = case_when(
  `CD3+ CD8- Percent` >= quantile(`CD3+ CD8- Percent`, .5, na.rm = TRUE) ~ 1,
  TRUE~ 0
)) 


sf_cd4 = surv_fit(Surv(survival_time, Death) ~ cd4_count_binary,conf.type = "log-log", data=cd4_data)


#Graph of Kaplan-Meier Curve
cd4_kaplan_primary = ggsurvplot(sf_cd4, 
   legend.title = "Cell Presence (CD4+)", 
   legend.labs = c("Low", "High"),
   #legend = c(.8, 0.8),
    font.legend = c(11, "bold", "black"),
   title = "C", 
   #subtitle = "T",
   xlab = "Time (days)",
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(12, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(3600, 0.6),
   conf.int = TRUE
   ) 

cd4_kaplan_primary$plot <- cd4_kaplan_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio:  0.61", size = 3)


coxph(Surv(survival_time, Death) ~ cd4_count_binary, data = cd4_data ) %>% 
  gtsummary::tbl_regression(exp = TRUE) 


surv_diff <- survdiff(Surv(survival_time, Death) ~ cd4_count_binary, data = cd4_data)


## all tumors included
cd4_data = cox_data %>% select(survival_time, `CD3+ CD8- Percent`, `Sample Name`, Death) %>% unique()

cd4_data = cd4_data  %>% mutate(cd4_count_binary = case_when(
  `CD3+ CD8- Percent` >= quantile(`CD3+ CD8- Percent`, .5, na.rm = TRUE) ~ 1,
  TRUE~ 0
)) 


sf_cd4 = surv_fit(Surv(survival_time, Death) ~ cd4_count_binary,conf.type = "log-log", data=cd4_data)


#Graph of Kaplan-Meier Curve
cd4_kaplan = ggsurvplot(sf_cd4, 
   legend.title = "Cell Presence (CD4+)", 
   legend.labs = c("Low", "High"),
   #legend = c(.8, 0.8),
    font.legend = c(11, "bold", "black"),
   title = "D", 
   #subtitle = "T",
   xlab = "Time (days)",
   ylab = NULL,
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(16, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 3,
   pval.coord = c(5400, 0.6),
   conf.int = TRUE
   ) 

cd4_kaplan$plot <- cd4_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio:  0.71", size = 3)


#coxph(Surv(survival_time, Death) ~ cd4_count_binary, data = cd4_data ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 


surv_diff <- survdiff(Surv(survival_time, Death) ~ cd4_count_binary, data = cd4_data)
```
## cell infiltrate main 3 graphs

```{r figure2, echo = FALSE, includE = TRUE, fig.align = "left", fig.width = 8, fig.height = 8}
# figure 2
x = list(bcell_kaplan_primary, cd4_kaplan_primary, macrophage_kaplan_primary, bcell_kaplan, cd4_kaplan, macrophage_kaplan)

graphs = arrange_ggsurvplots(x, 
  print = TRUE,
  title = NULL,
  ncol = 2,
  nrow = 3,
  surv.plot.height = NULL,
  risk.table.height = NULL,
  ncensor.plot.height = NULL,)

graphs
```


## cell infiltrate CD8 T Cell supplement

```{r, fig.align = "left", fig.width = 8, fig.height = 6}

x = list(tcell_kaplan_primary, tcell_kaplan)

graphs = arrange_ggsurvplots(x, 
  print = TRUE,
  title = NULL,
  ncol = 2,
  nrow = 1,
  surv.plot.height = NULL,
  risk.table.height = NULL,
  ncensor.plot.height = NULL,)

graphs
```

# Immune Cell Spatial Relationships - Binary classification - Hazard Ratio

*Note: the following analysis were also conducted but found to have not statistically significant results. 


## from with 25 microns - from CD19+ to CD68+ 

```{r}

sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data= count_within_macro_bcell %>% filter(Primary == "1"))

interaction_kaplan_primary = ggsurvplot(sf_distance, main= "",
           legend.title = "Interaction (CD19+, CD68+)", 
           #legend = c(.8, 0.9),
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "A", 
          # subtitle = "",
           xlab = "Time (days)",
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(12, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(3600, 0.7),
           conf.int = TRUE
   ) 


interaction_kaplan_primary$plot <- interaction_kaplan_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.54", size = 3) 

sf_interaction = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=cox_data)


surv_diff <- survdiff(Surv(survival_time, Death) ~ distance_to_binary, data = cox_data)


#binary distance to variable to get hazard ratio for kaplan
coxph(Surv(survival_time, Death) ~ distance_to_binary, data =  cox_data %>% filter(Primary == "1")) %>% 
 gtsummary::tbl_regression(exp = TRUE) 


# all tumor samples
sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data= count_within_macro_bcell)

interaction_kaplan = ggsurvplot(sf_distance, main= "",
           legend.title = "Interaction (CD19+, CD68+)", 
           #legend = c(.8, 0.9),
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "B", 
          # subtitle = "",
           xlab = "Time (days)",
           ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(5400, 0.7),
           conf.int = TRUE
   ) 


interaction_kaplan$plot <- interaction_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.64", size = 3) 

sf_interaction = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=cox_data)


surv_diff <- survdiff(Surv(survival_time, Death) ~ distance_to_binary, data = cox_data)
surv_diff


#binary distance to variable to get hazard ratio for kaplan
coxph(Surv(survival_time, Death) ~ distance_to_binary, data =  cox_data ) %>% 
 gtsummary::tbl_regression(exp = TRUE) 


```

## from with 25 microns - from CD3+ CD8+ to CD68+ 

```{r}


sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data= count_within_tcell_macro %>% filter(Primary=="1"))

tcell_macro_interaction_primary = ggsurvplot(sf_distance, main= "Survival Curve for macrophage Total Cell Count in Tumor Regions" ,
           legend.title = "Interaction (CD8+, CD68+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "A", 
           #subtitle = "",
           xlab = "Time (days)",
           #ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(12, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(3600, 0.7),
           conf.int = TRUE)

tcell_macro_interaction_primary$plot <- tcell_macro_interaction_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.89", size = 3)



#coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_tcell_macro %>% filter(Primary =="1") ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 


# all samples 
sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data= count_within_tcell_macro)

tcell_macro_interaction = ggsurvplot(sf_distance, main= "Survival Curve for macrophage Total Cell Count in Tumor Regions" ,
           legend.title = "Interaction (CD8+, CD68+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "B", 
           #subtitle = "",
           xlab = "Time (days)",
           ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(5400, 0.7),
           conf.int = TRUE)

tcell_macro_interaction$plot <- tcell_macro_interaction$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.85", size = 3)

#coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_tcell_macro ) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 
```


## from with 25 microns - from CD3+ CD8- to CD68+ 

```{r}

sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_cd4_macro %>% filter(Primary == "1") )

cd4_macro_interaction_primary = ggsurvplot(sf_distance, main= "" ,
           legend.title = "Interaction (CD4+, CD68+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "C", 
           #subtitle = "",
           xlab = "Time (days)",
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(12, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(3600, 0.7),
           conf.int = TRUE) 

cd4_macro_interaction_primary$plot <- cd4_macro_interaction_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.76", size = 3)


#coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_cd4_macro %>% filter(Primary=="1")) %>% 
#  gtsummary::tbl_regression(exp = TRUE) 

# all samples 
sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_cd4_macro )

cd4_macro_interaction = ggsurvplot(sf_distance, main= "" ,
           legend.title = "Interaction (CD4+, CD68+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "D", 
           #subtitle = "",
           xlab = "Time (days)",
           ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(5400, 0.7),
           conf.int = TRUE) 

cd4_macro_interaction$plot <- cd4_macro_interaction$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.85", size = 3)


coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_cd4_macro ) %>% 
  gtsummary::tbl_regression(exp = TRUE) 

```


## from with 25 microns - from to CD3+ CD8+ to CD3+ CD8-

```{r}


sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_cd4_tcell %>% filter(Primary == "1"))

cd4_tcell_distance_primary = ggsurvplot(sf_distance, main= "" ,
           legend.title = "Interaction (CD4+, CD8+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "C", 
           #subtitle = "",
           xlab = "Time (days)",
           #ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(12, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(3600, 0.7),
           conf.int = TRUE) 

cd4_tcell_distance_primary$plot <- cd4_tcell_distance_primary$plot+ 
              ggplot2::annotate("text", 
                                x = 4000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.84", size = 3)


#coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_cd4_tcell %>% filter(Primary=="1") ) %>% 
# gtsummary::tbl_regression(exp = TRUE) 

# all samples 

sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_cd4_tcell)

cd4_tcell_distance = ggsurvplot(sf_distance, main= "" ,
           legend.title = "Interaction (CD4+, CD8+)", 
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "D", 
           #subtitle = "",
           xlab = "Time (days)",
           ylab = NULL,
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 3,
           pval.coord = c(5400, 0.7),
           conf.int = TRUE) 

cd4_tcell_distance$plot <- cd4_tcell_distance$plot+ 
              ggplot2::annotate("text", 
                                x = 6000, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.88", size = 3)


#coxph(Surv(survival_time, Death) ~ distance_to_binary, data = count_within_cd4_tcell ) %>% 
# gtsummary::tbl_regression(exp = TRUE) 

```


```{r, eval = FALSE}

crude_model =  coxph(Surv(survival_time, Death) ~ from_with_macro_bcell_standard, data=count_within_macro_bcell)
summary(crude_model)


# Note, 50% of samples do not have B cells and T cells within 25 microns of each other.
```


```{r, eval = FALSE}
# CD4 Cells and B Cells 


phenos <- c("CD3+ CD8-", "CD19+")

# Calculating the nearest neighbor distance for each cell CD68+ and CD19+ cell. 

distance_macro_bcell <- ovarian_data_long %>% filter(Phenotype %in% c("CD3+ CD8-", "CD19+")) %>% filter(`Tissue Category`=="Tumor") %>%
  group_by(`Slide ID`,`Sample Name`) %>%
  do(bind_cols(., find_nearest_distance(., phenos))) %>% ungroup()


# Counting the number of CD19+ Cells that have at least one CD68+ cell within 25 microns. 


count_within_macro_bcell = distance_macro_bcell %>% filter(`Tissue Category`=="Tumor")  %>% group_by(`Sample Name`) %>% 
  do(count_within(., from='CD19+', to='CD3+ CD8-', radius=25)) %>% ungroup() 

#Selecting just the clinical variables neccesary, sample name, survival time, and death (for censoring)
clinical_data_count = image_with_clinical %>% select(`Sample Name`, survival_time, Death) %>% unique()


#Joining the cell totals in order to standardize the interaction variable across samples. 

count_within_macro_bcell = left_join(count_within_macro_bcell, clinical_data_count)
count_within_macro_bcell = left_join(count_within_macro_bcell, cell_totals_tumor)

count_within_macro_bcell = count_within_macro_bcell %>% group_by(`Sample Name`) %>% mutate(from_with_sd = (from_with/sum(`CD3+ CD8-`,`CD19+`))*100) %>% ungroup()

# standardizing the from_with count by dividing each sample by the total number of b cells and macrophages for that sample and multiplying by 100 for a percent of b cells and macrophages within 25 microns of each other of total b cells and macrophages



count_within_macro_bcell = count_within_macro_bcell %>% mutate(distance_to_binary=case_when(
  from_with_sd > quantile(count_within_macro_bcell$from_with_sd, .5, na.rm=TRUE) ~ 1,
  TRUE ~ 0,
))

names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with"] <- "from_with_macro_bcell"
names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with_sd"] <- "from_with_macro_bcell_standard"

## Removing the following sample from the cox_data set (which will include the survival curves because it does not have an exact date for date of death / last known alive. It does have a month though? )

count_within_macro_bcell = count_within_macro_bcell %>% filter(`Sample Name` != "B_Core[1,1,B]_[7934,35665].im3")


#count_within_macro_bcell$from_with_macro_bcell_standard[is.na(count_within_macro_bcell$from_with_macro_bcell_standard)] <- 0


crude_model =  coxph(Surv(survival_time, Death) ~ from_with_macro_bcell_standard, data=count_within_macro_bcell)
summary(crude_model)

# Note, 50% of samples do not have B cells and CD 4 T cells within 25 microns of each other.


```


## distance relationships kaplan curves - main two relationship


```{r figure3, echo = FALSE, include = TRUE, fig.align = "left", fig.width = 9, fig.height = 9}
# figure 3
x = list(interaction_kaplan_primary, cd4_macro_interaction_primary, interaction_kaplan,cd4_macro_interaction )

graphs_int = arrange_ggsurvplots(x, 
  print = TRUE,
  title = NULL,
  ncol = 2,
  nrow = 2,
  surv.plot.height = NULL,
  risk.table.height = NULL,
  ncensor.plot.height = NULL)

graphs_int
```
\textbf{Figure 3.} Kaplan-Meier curves for different combinations of cell distance interactions in tumor regions. A, Samples with a high percentage of B cells (CD19+) in close proximity to macrophages (CD68+) had higher overall survival probability compared to the low interaction group (p=0.046). The Hazard ratio of 0.64 suggests the samples with a high percentage of B cells in close proximity to macrophages had 0.64 times the risk of hazard (death) compared to the low group (95% CI: 0.41 - 0.99).  B, Samples with a high percentage of CD8+ T cells (CD3+ CD8+) in close proximity to macrophages (CD68+) did not differ significantly in survival probability from the low interaction group (p=0.47). C, Samples with a high percentage of CD4+ T cells (CD3+ CD8-) in close proximity to macrophages (CD68+) did not differ significantly in survival probability from the low interaction group (p=0.46). D, Samples with a high percentage of CD8+ T cells (CD3+ CD8+) in close proximity to CD4+ T cells (CD3+ CD8-) did not differ significantly in survival probability from the low interaction group (p=0.57). 


## supplement distance relatinoship graphs 


```{r figure6, echo = FALSE, include = TRUE, fig.align = "left", fig.width = 9, fig.height = 9}
# figure 3
x = list( tcell_macro_interaction_primary,  cd4_tcell_distance_primary, tcell_macro_interaction, cd4_tcell_distance)

graphs_int = arrange_ggsurvplots(x, 
  print = TRUE,
  title = NULL,
  ncol = 2,
  nrow = 2,
  surv.plot.height = NULL,
  risk.table.height = NULL,
  ncensor.plot.height = NULL)

graphs_int
```

# B Cell Infiltrate

* Note: we highlight that B Cell infiltrate alone is not significant in the cox proportional hazard models though it's binary, high or low categories, are in the Kaplan-Meier curves. 

## B Cell Infiltrate - Crude Model

```{r}

crude_model =  coxph(Surv(survival_time, Death) ~ `CD19+ Percent`, data=cox_data)
summary(crude_model)

# crude_model %>%
#   tbl_regression(
#     exponentiate = TRUE, 
#     pvalue_fun = ~style_pvalue(.x, digits = 2),
#   ) %>% 
#   add_global_p() %>%
#   bold_p(t = 0.10) %>%
#   bold_labels() %>%
#   italicize_levels()

```

* The presence of B cells in tumor regions alone is not a significant predictor in the hazard risk for patients (p=0.27). The adjusted models, which include the clinical variables show this same result. 

##  B Cell Infiltrate - Adjusted model B Cell Presence

* including clinical data variables and B Cell Percentage
```{r}

full_model =  coxph(Surv(survival_time, Death) ~ `Age at Diagnosis`  + `Treatment Effect` + Debulking +`CD19+ Percent`, data=cox_data)

summary(full_model)
# full_model %>%
#   tbl_regression(
#     exponentiate = TRUE, 
#     pvalue_fun = ~style_pvalue(.x, digits = 2),
#   ) %>% 
#   add_global_p() %>%
#   bold_p(t = 0.10) %>%
#   bold_labels() %>%
#   italicize_levels()
```
* The presence of B cells in tumor regions alone is not a significant predictor in the hazard risk for patients (p=0.26).  

# Cox Regressions for Cell Distance Relationships

## Crude Model B Cell / Macrophage Relationship

```{r}

crude_model =  coxph(Surv(survival_time, Death) ~ from_with_macro_bcell_standard, data=cox_data)

crude_model %>%
  tbl_regression(
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2),
  ) %>%
  add_global_p() %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()

```
* a one percent increase in the interaction variable is associated with a 10% decrease (p=0.0427) in the hazard (risk) of death (95% CI: 0.0032 - 17.4 percent). 

## Adjusted Model clinical with B Cell / Macrophage  Spatial relationship - 25 micron distance threshhold


```{r}

full_model =  coxph(Surv(survival_time, Death) ~from_with_macro_bcell_standard + `Age at Diagnosis` + `Treatment Effect` + Debulking, data=cox_data)

interaction_table =
  full_model %>%
  tbl_regression(
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 3),
  ) %>%
  add_global_p() %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
interaction_table
```
* a one percent increase in the interaction variable is associated with a 10.6% decrease (p= 0.0318) in the hazard (risk) of death (95% CI: 1 - 19.34 percent). 
* Additionally, a one year increase of age at diagnosis is associated with a 3% increase (p<0.05) in the hazard (risk) of death (95% CI: 0.5 - 5.5 percent). 


## Crude cox models for other cell spatial interaction combinations

```{R}
#cd4 t cell and CD8+ t cell 

crude_model =  coxph(Surv(survival_time, Death) ~ from_with_cd4_tcell_standard, data=count_within_cd4_tcell)
summary(crude_model)

# CD4 T cell and Macrophage (CD68+)
crude_model =  coxph(Surv(survival_time, Death) ~ from_with_cd4_macro_standard, data=count_within_cd4_macro)
summary(crude_model)


# T cell (CD8+) and Macrophage (CD68+)
crude_model =  coxph(Surv(survival_time, Death) ~ from_with_tcell_macro_standard, data=count_within_tcell_macro)
summary(crude_model)

```

#adjusted with cd4 macro

```{r, eval = FALSE}
count1 =  count_within_cd4_macro %>% select(`Sample Name`, from_with_cd4_macro, from_with_cd4_macro_standard, distance_to_binary)


# Combining cell_totals_tumor with count_within_data


# Cox regression data - single row per sample - Cell totals in tumor regions, clinical data, distance data, 
cox_data_cd4 = left_join(cell_totals_tumor, clinical_data)

cox_data_cd4 = left_join(cox_data_cd4, count1)


#changing factor levels for debulking 
cox_data_cd4$Debulking = relevel(cox_data_cd4$Debulking, ref = "Optimal")

# changing Grade to factor and setting 3 as ref (most common)

cox_data_cd4$Grade = factor(cox_data_cd4$Grade)
cox_data_cd4$Grade = relevel(cox_data_cd4$Grade, ref = "3")


# Changing structure of PARPi variable to have 0 for no, 1 for yes. Setting as factor variable with reference 0
cox_data_cd4$PARPi = ifelse(cox_data_cd4$PARPi=="Y", 1, 0)
cox_data_cd4$PARPi= factor(cox_data_cd4$PARPi)
cox_data_cd4$PARPi = relevel(cox_data_cd4$PARPi, ref = "0")

# Setting Primary as factor variable with reference category = 1

cox_data_cd4$Primary = factor(cox_data_cd4$Primary)
cox_data_cd4$Primary = relevel(cox_data_cd4$Primary, ref = "1")


# Setting Treatment effect as a factor variable with reference category 0

cox_data_cd4$`Treatment Effect` = factor(cox_data_cd4$`Treatment Effect`)
cox_data_cd4$`Treatment Effect` = relevel(cox_data_cd4$`Treatment Effect`, ref = "0")


## Removing the following sample from the cox_data set (which will include the survival curves because it does not have an exact date for date of death / last known alive. ? )

cox_data_cd4 = cox_data_cd4 %>% filter(`Sample Name` != "B_Core[1,1,B]_[7934,35665].im3")

full_model =  coxph(Surv(survival_time, Death) ~from_with_cd4_macro_standard + `Age at Diagnosis` + `Treatment Effect` + Debulking, data=cox_data_cd4)

summary(full_model)


interaction_table =
  full_model %>%
  tbl_regression(
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 3),
  ) %>%
  add_global_p() %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()
interaction_table
```


# Time to Event Variable 

* event is recurrence or death (whichever occurs first.)

```{r, eval = FALSE}
# recurrence binary 

clinical_data = clinical_data %>% group_by(`Sample Name`) %>% mutate(recurrence_binary = if_else(is.na(Recurence1), 0, 1)) %>% ungroup()

# time to event binary 

clinical_data = clinical_data %>% group_by(`Sample Name`) %>% mutate(time_to_event_binary = case_when(
  recurrence_binary == "1" ~ "1",
  Death == "1" ~ "1",
  TRUE ~ "0"
)) %>% ungroup()

# Recurrence date formatting; looking at just the first date from the recurrence column. 

clinical_data$recurrence_date = ymd(clinical_data$Recurence1)

# time to recurrence
clinical_data$time_to_recurrence =  clinical_data$recurrence_date - clinical_data$`Date of Diagnosis`

# Need variable that is time to recurrence or survival time 

clinical_data = clinical_data %>% group_by(`Sample Name`) %>% mutate(time_to_event = if_else(is.na(time_to_recurrence), survival_time, time_to_recurrence)) %>% ungroup()

```

## Kaplan meier curve for time to event - B Cell Infiltrate

```{r}
## Survival curve for B Cell (CD19+) presence tumor region (count)


bcell_data_rec = cox_data %>% select(time_to_event, `CD19+ Percent`, `Sample Name`, time_to_event_binary) %>% unique()

bcell_data_rec = bcell_data_rec  %>% mutate(bcell_percent_binary = case_when(
  `CD19+ Percent` >= quantile(`CD19+ Percent`, .5, na.rm = TRUE) ~ 1,
  TRUE~ 0
)) 


sf_bcell = surv_fit(Surv(time_to_event, time_to_event_binary) ~ bcell_percent_binary, conf.type = "log-log", data=bcell_data_rec)


#Graph of Kaplan-Meier Curve

bcell_kaplan  = ggsurvplot(sf_bcell, 
   legend.title = "Cell Presence (CD19+)", 
   legend.labs = c("Low", "High"),
   #legend = c(7000, 0.8),
   font.legend = c(11, "bold", "black"),
   title = "A", 
   #subtitle = "",
   xlab = "Time (days)",
   ylab = "Progression-Free Survival Probability",
   font.title = c(14, "bold", "black"),
   #font.subtitle = c(12, "bold.italic", "black"),
   font.x = c(12, "bold.italic", "black"),
   font.y = c(16, "bold.italic", "black"),
   risk.table = FALSE, 
   ncensor.plot = FALSE,
   pval=TRUE,
   pval.size = 5,
   pval.coord = c(2100, 0.72),
   conf.int = TRUE
   ) 

bcell_kaplan$plot <- bcell_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 2500, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.96", size = 5)


#sf_bcell
#hazard ratio
#coxph(Surv(time_to_event, time_to_event_binary) ~ bcell_percent_binary, data =  bcell_data_rec ) %>% 
# gtsummary::tbl_regression(exp = TRUE) 

```


* Median time to event (recurrence or death) for high b cell percent samples is 686 (95 CI: 604 - 884) vs low percentage median of 664 (95 CI: 569 - 864)
* In high b cell groups, 6 with no event and 46 with event and in low group, 7 with no event and 43 with event. 
 
 
## Kaplan meier curve for time to event - B Cell Macro relation

```{r figure4, echo = FALSE, include = TRUE, fig.align = "left", fig.width = 9, fig.height = 6}
sf_distance = surv_fit(Surv(time_to_event, as.numeric(time_to_event_binary)) ~ distance_to_binary, conf.type = "log-log", data=cox_data)

interaction_kaplan = ggsurvplot(sf_distance, main= "",
           legend.title = "Interaction (CD19+, CD68+)", 
           #legend = c(.8, 0.9),
           legend.labs = c("Low", "High"),
           font.legend = c(11, "bold", "black"),
           title = "B", 
          # subtitle = "",
           xlab = "Time (days)",
           ylab = "Progression-Free Survival Probability",
           font.title = c(14, "bold", "black"),
           #font.subtitle = c(12, "bold.italic", "black"),
           font.x = c(12, "bold.italic", "black"),
           font.y = c(16, "bold.italic", "black"),
           risk.table = FALSE,
           pval=TRUE,
           pval.size = 5,
           pval.coord = c(2100, 0.72),
           conf.int = TRUE
   ) 


interaction_kaplan$plot <- interaction_kaplan$plot+ 
              ggplot2::annotate("text", 
                                x = 2500, y = .8, # x and y coordinates of the text
                                label = "Hazard Ratio: 0.8", size = 5) 

sf_interaction = surv_fit(Surv(time_to_event, time_to_event_binary) ~ distance_to_binary, conf.type = "log-log", data=cox_data)


surv_diff <- survdiff(Surv(time_to_event, time_to_event_binary) ~ distance_to_binary, data = cox_data)
surv_diff

#hazard ratio
#coxph(Surv(time_to_event, time_to_event_binary) ~ distance_to_binary, data =  cox_data ) %>% 
# gtsummary::tbl_regression(exp = TRUE)

x = list(bcell_kaplan, interaction_kaplan)

graphs_int = arrange_ggsurvplots(x, 
  print = TRUE,
  title = NULL,
  ncol = 2,
  nrow = 1,
  surv.plot.height = NULL,
  risk.table.height = NULL,
  ncensor.plot.height = NULL)

graphs_int
```

* Median time to event for high b cell macro interaction is 692 (95 CI: 604 - 943) vs median for low group 661 ( 95 CI: 510 - 853)
* In the high interaction group, there are 7 people with no event and 53 with event. In the low interaction group, there are 6 with no event and 61 with event. 

## Cox Proportional - B cell infiltrate - Time To event (recurrence or death)

```{r}

full_model =  coxph(Surv(time_to_event, time_to_event_binary) ~ `CD19+ Percent` + `Age at Diagnosis`  +  `Treatment Effect` + Debulking, data=cox_data)

# full_model %>%
#   tbl_regression(
#     exponentiate = TRUE, 
#     pvalue_fun = ~style_pvalue(.x, digits = 2),
#   ) %>% 
#   add_global_p() %>%
#   bold_p(t = 0.10) %>%
#   bold_labels() %>%
#   italicize_levels()
```



## Crude Cox Proportional - B Cell Macro relation - Time To event (recurrence or death)

```{r}
crude_model =  coxph(Surv(time_to_event, time_to_event_binary) ~ from_with_macro_bcell_standard, data=cox_data)
summary(crude_model)
# 
# 
# crude_model %>%
#   tbl_regression(
#     exponentiate = TRUE, 
#     pvalue_fun = ~style_pvalue(.x, digits = 2),
#   ) %>% 
#   add_global_p() %>%
#   bold_p(t = 0.10) %>%
#   bold_labels() %>%
#   italicize_levels()

```


## Adjusted Model clinical with B Cell / Macrophage Interaction - Time To event (recurrence or death)


```{r}

full_model =  coxph(Surv(time_to_event, time_to_event_binary) ~from_with_macro_bcell_standard + `Age at Diagnosis`  +  `Treatment Effect` + Debulking, data=cox_data)

# full_model %>%
#   tbl_regression(
#     exponentiate = TRUE, 
#     pvalue_fun = ~style_pvalue(.x, digits = 2),
#   ) %>% 
#   add_global_p() %>%
#   bold_p(t = 0.10) %>%
#   bold_labels() %>%
#   italicize_levels()

```

# Distance Variations for B Cell Macro

## Adjusted Model clinical with B Cell / Macrophage  Spatial relationship - 20 micron distance threshhold

```{r, eval = FALSE }
count_within_macro_bcell = distance_macro_bcell %>% filter(`Tissue Category`=="Tumor")  %>% group_by(`Sample Name`) %>% 
  do(count_within(., from='CD19+', to='CD68+', radius=20)) %>% ungroup() 

#Selecting just the clinical variables neccesary, sample name, survival time, and death (for censoring)
clinical_data_count = image_with_clinical %>% select(`Sample Name`, survival_time, Death) %>% unique()


#Joining the cell totals in order to standardize the interaction variable across samples. 

count_within_macro_bcell = left_join(count_within_macro_bcell, clinical_data_count)
count_within_macro_bcell = left_join(count_within_macro_bcell, cell_totals_tumor)

count_within_macro_bcell = count_within_macro_bcell %>% group_by(`Sample Name`) %>% mutate(from_with_sd = (from_with/sum(`CD68+`,`CD19+`))*100) %>% ungroup()

# standardizing the from_with count by dividing each sample by the total number of b cells and macrophages for that sample and multiplying by 100 for a percent of b cells and macrophages within 25 microns of each other of total b cells and macrophages



count_within_macro_bcell = count_within_macro_bcell %>% mutate(distance_to_binary=case_when(
  from_with_sd > quantile(count_within_macro_bcell$from_with_sd, .5, na.rm=TRUE) ~ 1,
  TRUE ~ 0,
))

#reformatting names

names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with"] <- "from_with_macro_bcell"
names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with_sd"] <- "from_with_macro_bcell_standard"

## Removing the following sample from the cox_data set (which will include the survival curves because it does not have an exact date for date of death / last known alive. ? )

count_within_macro_bcell = count_within_macro_bcell %>% filter(`Sample Name` != "B_Core[1,1,B]_[7934,35665].im3")


# survival curve function  for Kaplan Meier
sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_macro_bcell)


# Selecting just sample size and from with counts from count_within_data frame

count1 =  count_within_macro_bcell %>% select(`Sample Name`, from_with_macro_bcell, from_with_macro_bcell_standard, distance_to_binary)


# Combining cell_totals_tumor with count_within_data


# Cox regression data - single row per sample - Cell totals in tumor regions, clinical data, distance data, 
cox_data20 = left_join(cell_totals_tumor, clinical_data)

cox_data20 = left_join(cox_data20, count1)


#changing factor levels for debulking 
cox_data20$Debulking = relevel(cox_data20$Debulking, ref = "Optimal")

# changing Grade to factor and setting 3 as ref (most common)

cox_data20$Grade = factor(cox_data20$Grade)
cox_data20$Grade = relevel(cox_data20$Grade, ref = "3")


# Changing structure of PARPi variable to have 0 for no, 1 for yes. Setting as factor variable with reference 0
cox_data20$PARPi = ifelse(cox_data20$PARPi=="Y", 1, 0)
cox_data20$PARPi= factor(cox_data20$PARPi)
cox_data20$PARPi = relevel(cox_data20$PARPi, ref = "0")

# Setting Primary as factor variable with reference category = 1

cox_data20$Primary = factor(cox_data20$Primary)
cox_data20$Primary = relevel(cox_data20$Primary, ref = "1")


# Setting Treatment effect as a factor variable with reference category 0

cox_data20$`Treatment Effect` = factor(cox_data20$`Treatment Effect`)
cox_data20$`Treatment Effect` = relevel(cox_data20$`Treatment Effect`, ref = "0")


full_model =  coxph(Surv(survival_time, Death) ~from_with_macro_bcell_standard + `Age at Diagnosis`  +  `Treatment Effect` + Debulking, data=cox_data20)

summary(full_model)

distance20 = full_model %>%
  tbl_regression(
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2),
  ) %>%
  add_global_p() %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()

```



## Adjusted Model clinical with B Cell / Macrophage  Spatial relationship - 30 micron distance threshhold

```{r, eval = FALSE}
count_within_macro_bcell = distance_macro_bcell %>% filter(`Tissue Category`=="Tumor")  %>% group_by(`Sample Name`) %>% 
  do(count_within(., from='CD19+', to='CD68+', radius=30)) %>% ungroup() 

#Selecting just the clinical variables neccesary, sample name, survival time, and death (for censoring)
clinical_data_count = image_with_clinical %>% select(`Sample Name`, survival_time, Death) %>% unique()


#Joining the cell totals in order to standardize the interaction variable across samples. 

count_within_macro_bcell = left_join(count_within_macro_bcell, clinical_data_count)
count_within_macro_bcell = left_join(count_within_macro_bcell, cell_totals_tumor)

count_within_macro_bcell = count_within_macro_bcell %>% group_by(`Sample Name`) %>% mutate(from_with_sd = (from_with/sum(`CD68+`,`CD19+`))*100) %>% ungroup()

# standardizing the from_with count by dividing each sample by the total number of b cells and macrophages for that sample and multiplying by 100 for a percent of b cells and macrophages within 25 microns of each other of total b cells and macrophages



count_within_macro_bcell = count_within_macro_bcell %>% mutate(distance_to_binary=case_when(
  from_with_sd > quantile(count_within_macro_bcell$from_with_sd, .5, na.rm=TRUE) ~ 1,
  TRUE ~ 0,
))

#reformatting names

names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with"] <- "from_with_macro_bcell"
names(count_within_macro_bcell)[names(count_within_macro_bcell) == "from_with_sd"] <- "from_with_macro_bcell_standard"

## Removing the following sample from the cox_data set (which will include the survival curves because it does not have an exact date for date of death / last known alive. ? )

count_within_macro_bcell = count_within_macro_bcell %>% filter(`Sample Name` != "B_Core[1,1,B]_[7934,35665].im3")


# survival curve function  for Kaplan Meier
sf_distance = surv_fit(Surv(survival_time, Death) ~ distance_to_binary, conf.type = "log-log", data=count_within_macro_bcell)


# Selecting just sample size and from with counts from count_within_data frame

count1 =  count_within_macro_bcell %>% select(`Sample Name`, from_with_macro_bcell, from_with_macro_bcell_standard, distance_to_binary)


# Combining cell_totals_tumor with count_within_data


# Cox regression data - single row per sample - Cell totals in tumor regions, clinical data, distance data, 
cox_data30 = left_join(cell_totals_tumor, clinical_data)

cox_data30 = left_join(cox_data30, count1)


#changing factor levels for debulking 
cox_data30$Debulking = relevel(cox_data30$Debulking, ref = "Optimal")

# changing Grade to factor and setting 3 as ref (most common)

cox_data30$Grade = factor(cox_data30$Grade)
cox_data30$Grade = relevel(cox_data30$Grade, ref = "3")


# Changing structure of PARPi variable to have 0 for no, 1 for yes. Setting as factor variable with reference 0
cox_data30$PARPi = ifelse(cox_data30$PARPi=="Y", 1, 0)
cox_data30$PARPi= factor(cox_data30$PARPi)
cox_data30$PARPi = relevel(cox_data30$PARPi, ref = "0")

# Setting Primary as factor variable with reference category = 1

cox_data30$Primary = factor(cox_data30$Primary)
cox_data30$Primary = relevel(cox_data30$Primary, ref = "1")


# Setting Treatment effect as a factor variable with reference category 0

cox_data30$`Treatment Effect` = factor(cox_data30$`Treatment Effect`)
cox_data30$`Treatment Effect` = relevel(cox_data30$`Treatment Effect`, ref = "0")


full_model =  coxph(Surv(survival_time, Death) ~from_with_macro_bcell_standard + `Age at Diagnosis`  + `Treatment Effect` + Debulking, data=cox_data30)


distance30 = full_model %>%
  tbl_regression(
    exponentiate = TRUE,
    pvalue_fun = ~style_pvalue(.x, digits = 2),
  ) %>%
  add_global_p() %>%
  bold_p(t = 0.10) %>%
  bold_labels() %>%
  italicize_levels()

```

```{R, eval = FALSE}
table_dif_distance <-
  tbl_merge(
    tbls = list(distance20, distance30), 
    tab_spanner = c("20 Micron Threshold", "30 Micron Threshold") 
  ) 
table_dif_distance
```


